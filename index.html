<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>HUD + Map (Naver) - Debug</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #0ff;
    }

    #app {
      position: relative;
      height: 100%;
    }

    #map {
      position: absolute;
      inset: 0;
    }

    .hud {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      padding: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      z-index: 100;
    }

    .speed {
      font-size: 64px;
      font-weight: 800;
      letter-spacing: 1px;
      text-shadow: 0 0 8px #0ff;
    }

    .meta {
      font-size: 14px;
      opacity: .9
    }

    .panel {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      pointer-events: auto;
      flex-wrap: wrap;
      z-index: 100;
    }

    .btn {
      background: #011;
      color: #0ff;
      border: 1px solid #055;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
    }

    .mirror {
      transform: scaleX(-1);
    }

    .debug {
      position: absolute;
      top: 140px;
      left: 12px;
      right: 12px;
      bottom: 80px;
      background: rgba(0, 0, 0, 0.95);
      color: #0ff;
      padding: 12px;
      font-family: monospace;
      font-size: 11px;
      border: 2px solid #055;
      overflow-y: auto;
      z-index: 200;
      display: none;
    }

    .debug.show {
      display: block;
    }

    .log {
      margin: 4px 0;
      padding: 4px;
      border-left: 2px solid #055;
      padding-left: 8px;
    }

    .log.error {
      color: #f00;
      border-left-color: #f00;
    }

    .log.success {
      color: #0f0;
      border-left-color: #0f0;
    }

    .log.warn {
      color: #ff0;
      border-left-color: #ff0;
    }

    .status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      color: #0ff;
      padding: 24px;
      border: 2px solid #055;
      border-radius: 12px;
      text-align: center;
      font-family: monospace;
      z-index: 300;
      max-width: 80%;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="map"></div>

    <div id="status" class="status">
      <div style="font-size:32px; margin-bottom:12px;">ğŸ“</div>
      <div style="font-size:18px; margin-bottom:12px;">GPS ì´ˆê¸°í™” ì¤‘...</div>
      <div style="font-size:12px; opacity:0.7;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>

    <div class="hud">
      <div class="speed" id="speed">--</div>
      <div class="meta">
        <div>HDG <span id="heading">--</span>Â°</div>
        <div>LAT <span id="lat">--</span> Â· LNG <span id="lng">--</span></div>
        <div>ACC <span id="acc">--</span>m Â· ALT <span id="alt">--</span>m</div>
        <div style="font-size:10px; opacity:0.6; margin-top:4px;">
          Updates: <span id="updateCount">0</span> Â·
          Last: <span id="lastUpdate">--</span>
        </div>
      </div>
    </div>

    <div class="debug" id="debugPanel">
      <div
        style="position:sticky; top:0; background:#000; padding:8px 0; margin-bottom:8px; border-bottom:1px solid #055;">
        <strong>ğŸ” ì‹¤ì‹œê°„ ë””ë²„ê·¸ ë¡œê·¸</strong>
        <button onclick="document.getElementById('debugLog').innerHTML=''"
          style="float:right; background:#011; color:#0ff; border:1px solid #055; padding:4px 8px; border-radius:4px; cursor:pointer;">Clear</button>
      </div>
      <div id="debugLog"></div>
    </div>

    <div class="panel">
      <button class="btn" id="debugBtn">ğŸ” ë””ë²„ê·¸</button>
      <button class="btn" id="requestGpsBtn">ğŸ“ GPS ì¬ìš”ì²­</button>
      <button class="btn" id="mirrorBtn">ë¯¸ëŸ¬</button>
      <button class="btn" id="themeBtn">í…Œë§ˆ</button>
      <button class="btn" id="pauseBtn">ì¼ì‹œì •ì§€</button>
    </div>
  </div>

  <script>
    (function () {
      const statusDiv = document.getElementById('status');
      const debugPanel = document.getElementById('debugPanel');
      const debugLog = document.getElementById('debugLog');

      let logCount = 0;
      const maxLogs = 100;

      function log(msg, type = 'info') {
        console.log(`[${type.toUpperCase()}]`, msg);

        const time = new Date().toLocaleTimeString();
        const logEl = document.createElement('div');
        logEl.className = `log ${type}`;
        logEl.innerHTML = `<span style="opacity:0.6;">[${time}]</span> ${msg}`;

        debugLog.insertBefore(logEl, debugLog.firstChild);

        logCount++;
        if (logCount > maxLogs) {
          debugLog.removeChild(debugLog.lastChild);
          logCount--;
        }
      }

      function showStatus(emoji, title, desc = '') {
        statusDiv.innerHTML = `
      <div style="font-size:32px; margin-bottom:12px;">${emoji}</div>
      <div style="font-size:18px; margin-bottom:12px;">${title}</div>
      ${desc ? `<div style="font-size:12px; opacity:0.7;">${desc}</div>` : ''}
    `;
        statusDiv.style.display = 'block';
      }

      function hideStatus() {
        statusDiv.style.display = 'none';
      }

      // Naver Maps API ë¡œë“œ
      async function loadNaverMapsAPI() {
        return new Promise((resolve, reject) => {
          if (window.naver && window.naver.maps) {
            log('âœ“ Naver Maps API ì´ë¯¸ ë¡œë“œë¨', 'success');
            resolve();
            return;
          }

          const existingScript = document.querySelector('script[src*="oapi.map.naver.com"]');
          if (existingScript) {
            log('ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°', 'warn');
            existingScript.remove();
          }

          log('Naver Maps API ë¡œë“œ ì‹œì‘...', 'info');
          const script = document.createElement('script');
          script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=i6my73bw6a';
          script.async = false;

          script.onload = () => {
            setTimeout(() => {
              if (window.naver && window.naver.maps) {
                log('âœ“ Naver Maps API ë¡œë“œ ì„±ê³µ', 'success');
                resolve();
              } else {
                log('âŒ API ë¡œë“œëì§€ë§Œ naver.maps ì—†ìŒ', 'error');
                reject(new Error('naver.maps not available'));
              }
            }, 100);
          };

          script.onerror = () => {
            log('âŒ Naver Maps API ë¡œë“œ ì‹¤íŒ¨', 'error');
            reject(new Error('Failed to load API'));
          };

          document.head.appendChild(script);
        });
      }

      let map = null;
      let marker = null;
      let updateCount = 0;
      let lastPosition = null;
      let watchId = null;

      const $speed = document.getElementById('speed');
      const $heading = document.getElementById('heading');
      const $lat = document.getElementById('lat');
      const $lng = document.getElementById('lng');
      const $acc = document.getElementById('acc');
      const $alt = document.getElementById('alt');
      const $updateCount = document.getElementById('updateCount');
      const $lastUpdate = document.getElementById('lastUpdate');
      const $app = document.getElementById('app');

      // Helper functions
      const toKmh = v => v == null ? null : Math.max(0, v * 3.6);
      const ema = (alpha) => {
        let v = null;
        return x => {
          v = (v == null) ? x : (alpha * x + (1 - alpha) * v);
          return v;
        };
      };

      const smoothSpeed = ema(0.35);
      const smoothHeading = ema(0.25);

      function bearing(lat1, lon1, lat2, lon2) {
        const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180;
        const Î»1 = lon1 * Math.PI / 180, Î»2 = lon2 * Math.PI / 180;
        const y = Math.sin(Î»2 - Î»1) * Math.cos(Ï†2);
        const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î»2 - Î»1);
        let Î¸ = Math.atan2(y, x) * 180 / Math.PI;
        return (Î¸ + 360) % 360;
      }

      // GPS ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
      let paused = false;

      function onPosition(position) {
        updateCount++;
        $updateCount.textContent = updateCount;
        $lastUpdate.textContent = new Date().toLocaleTimeString();

        if (updateCount === 1) {
          log('ğŸ‰ ì²« GPS ìœ„ì¹˜ ìˆ˜ì‹ !', 'success');
          hideStatus();
        }

        if (paused) {
          log('ì¼ì‹œì •ì§€ ìƒíƒœ - ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€', 'warn');
          return;
        }

        const { latitude, longitude, accuracy, altitude, speed, heading: gpsHeading } = position.coords;

        log(`GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}, ì†ë„: ${speed?.toFixed(2) || 'null'} m/s`, 'info');

        // ì†ë„ ê³„ì‚°
        let kmh = null;

        // ë°©ë²• 1: GPSì—ì„œ ì§ì ‘ ì œê³µí•˜ëŠ” ì†ë„ (ê°€ì¥ ì •í™•)
        if (speed !== null && speed !== undefined && !isNaN(speed)) {
          kmh = toKmh(speed);
          log(`âœ“ GPS ì†ë„ ì‚¬ìš©: ${kmh.toFixed(1)} km/h`, 'success');
        }
        // ë°©ë²• 2: ì´ì „ ìœ„ì¹˜ì™€ì˜ ê±°ë¦¬/ì‹œê°„ìœ¼ë¡œ ê³„ì‚°
        else if (lastPosition) {
          const timeDiff = (position.timestamp - lastPosition.timestamp) / 1000; // ì´ˆ
          if (timeDiff > 0.5) {
            const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (m)
            const Ï†1 = lastPosition.latitude * Math.PI / 180;
            const Ï†2 = latitude * Math.PI / 180;
            const Î”Ï† = (latitude - lastPosition.latitude) * Math.PI / 180;
            const Î”Î» = (longitude - lastPosition.longitude) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // ë¯¸í„°

            const speedMs = distance / timeDiff;
            kmh = toKmh(speedMs);
            log(`âœ“ ê³„ì‚°ëœ ì†ë„: ${kmh.toFixed(1)} km/h (ê±°ë¦¬: ${distance.toFixed(1)}m, ì‹œê°„: ${timeDiff.toFixed(1)}s)`, 'success');
          }
        }

        // ì†ë„ê°€ ì—¬ì „íˆ nullì´ë©´ 0ìœ¼ë¡œ ì„¤ì •
        if (kmh === null) {
          kmh = 0;
          log('ì†ë„ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŒ - 0ìœ¼ë¡œ ì„¤ì •', 'warn');
        }

        // ìŠ¤ë¬´ë”©
        kmh = smoothSpeed(kmh);

        // ë°©í–¥ ê³„ì‚°
        let hdg = null;
        if (gpsHeading !== null && gpsHeading !== undefined && !isNaN(gpsHeading)) {
          hdg = gpsHeading;
        } else if (lastPosition && kmh > 2) { // 2km/h ì´ìƒì¼ ë•Œë§Œ ë°©í–¥ ê³„ì‚°
          hdg = bearing(lastPosition.latitude, lastPosition.longitude, latitude, longitude);
        }

        if (hdg !== null) {
          hdg = smoothHeading(hdg);
        }

        // HUD ì—…ë°ì´íŠ¸
        $speed.textContent = Math.round(kmh);
        $heading.textContent = hdg !== null ? Math.round(hdg) : '--';
        $lat.textContent = latitude.toFixed(6);
        $lng.textContent = longitude.toFixed(6);
        $acc.textContent = accuracy !== null ? Math.round(accuracy) : '--';
        $alt.textContent = altitude !== null ? Math.round(altitude) : '--';

        // ë§µ ì—…ë°ì´íŠ¸
        if (map && marker) {
          try {
            const latlng = new naver.maps.LatLng(latitude, longitude);
            marker.setPosition(latlng);
            map.setCenter(latlng);
          } catch (e) {
            log('ë§µ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + e.message, 'error');
          }
        }

        // ì´ì „ ìœ„ì¹˜ ì €ì¥
        lastPosition = {
          latitude,
          longitude,
          timestamp: position.timestamp
        };
      }

      function onPositionError(error) {
        log(`âŒ GPS ì˜¤ë¥˜ [ì½”ë“œ ${error.code}]: ${error.message}`, 'error');

        let emoji = 'âš ï¸';
        let title = 'GPS ì˜¤ë¥˜';
        let desc = '';

        switch (error.code) {
          case 1: // PERMISSION_DENIED
            emoji = 'ğŸš«';
            title = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
            desc = 'ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”';
            break;
          case 2: // POSITION_UNAVAILABLE
            emoji = 'ğŸ“¡';
            title = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            desc = 'GPS ì‹ í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš” (ì‹¤ì™¸ì—ì„œ í…ŒìŠ¤íŠ¸)';
            break;
          case 3: // TIMEOUT
            emoji = 'â±ï¸';
            title = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ ì´ˆê³¼';
            desc = 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
            break;
        }

        showStatus(emoji, title, desc);
      }

      // GPS ì‹œì‘
      function startGPS() {
        if (!navigator.geolocation) {
          log('âŒ Geolocation API ë¯¸ì§€ì›', 'error');
          showStatus('âŒ', 'GPS ë¯¸ì§€ì›', 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
          return;
        }

        log('ğŸ“ GPS ìš”ì²­ ì¤‘...', 'info');
        log(`í˜„ì¬ í”„ë¡œí† ì½œ: ${window.location.protocol}`, 'info');
        log(`í˜„ì¬ ë„ë©”ì¸: ${window.location.hostname}`, 'info');

        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
          log('âš ï¸ HTTPSê°€ ì•„ë‹™ë‹ˆë‹¤. GPSê°€ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warn');
        }

        showStatus('ğŸ“', 'GPS ì‹ í˜¸ ëŒ€ê¸° ì¤‘...', 'ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”');

        // ê¸°ì¡´ watchPosition ì •ë¦¬
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          log('ê¸°ì¡´ GPS watch ì •ë¦¬', 'info');
        }

        // GPS ì˜µì…˜
        const options = {
          enableHighAccuracy: true,  // ê³ ì •ë°€ ëª¨ë“œ
          timeout: 10000,            // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
          maximumAge: 0              // ìºì‹œ ì‚¬ìš© ì•ˆ í•¨
        };

        log(`GPS ì˜µì…˜: ${JSON.stringify(options)}`, 'info');

        // watchPosition ì‹œì‘
        watchId = navigator.geolocation.watchPosition(
          onPosition,
          onPositionError,
          options
        );

        log(`âœ“ GPS watchPosition ì‹œì‘ (ID: ${watchId})`, 'success');
      }

      // ì´ˆê¸°í™”
      async function init() {
        log('=== ì•± ì´ˆê¸°í™” ì‹œì‘ ===', 'info');
        log(`User Agent: ${navigator.userAgent}`, 'info');

        // ë§µ ì´ˆê¸°í™”
        try {
          await loadNaverMapsAPI();

          const mapDiv = document.getElementById('map');
          mapDiv.innerHTML = '';

          map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5665, 126.9780),
            zoom: 17,
            mapDataControl: false,
            logoControl: false,
            scaleControl: false,
            zoomControl: false,
            mapTypeControl: false
          });

          const markerEl = document.createElement('div');
          markerEl.style.cssText = `
        width: 40px; height: 40px; 
        background: radial-gradient(circle, #0ff 0%, #0ff 40%, transparent 40%);
        border-radius: 50%;
        border: 3px solid #0ff;
        box-shadow: 0 0 20px #0ff;
      `;

          marker = new naver.maps.Marker({
            position: map.getCenter(),
            map,
            icon: {
              content: markerEl.outerHTML,
              anchor: new naver.maps.Point(20, 20)
            }
          });

          log('âœ“ ë§µ ì´ˆê¸°í™” ì„±ê³µ', 'success');
        } catch (e) {
          log('âŒ ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message, 'error');
          log('ë§µ ì—†ì´ ê³„ì† ì§„í–‰...', 'warn');
        }

        // GPS ì‹œì‘
        startGPS();

        log('=== ì´ˆê¸°í™” ì™„ë£Œ ===', 'success');
      }

      // ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('debugBtn').onclick = () => {
        debugPanel.classList.toggle('show');
      };

      document.getElementById('requestGpsBtn').onclick = () => {
        log('=== ìˆ˜ë™ GPS ì¬ìš”ì²­ ===', 'info');
        startGPS();
      };

      document.getElementById('mirrorBtn').onclick = () => {
        $app.classList.toggle('mirror');
      };

      let dark = true;
      document.getElementById('themeBtn').onclick = () => {
        dark = !dark;
        document.body.style.background = dark ? '#000' : '#fff';
        document.querySelector('.hud').style.color = dark ? '#0ff' : '#005';
      };

      document.getElementById('pauseBtn').onclick = () => {
        paused = !paused;
        document.getElementById('pauseBtn').textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
        log(paused ? 'ì¼ì‹œì •ì§€ë¨' : 'ì¬ê°œë¨', 'info');
      };

      // ì´ˆê¸°í™” ì‹œì‘
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>

</html>