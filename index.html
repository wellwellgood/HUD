<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="referrer" content="strict-origin-when-cross-origin">
<title>HUD + Map (Naver) - Fixed</title>
<style>
  html, body { height: 100%; margin: 0; background:#000; color:#0ff; }
  #app { position:relative; height:100%; }
  #map { position:absolute; inset:0; }
  .hud {
    position:absolute; left:0; right:0; top:0; padding:16px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    pointer-events:none; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  }
  .speed { font-size:64px; font-weight:800; letter-spacing:1px; text-shadow:0 0 8px #0ff; }
  .meta  { font-size:14px; opacity:.9 }
  .panel {
    position:absolute; bottom:12px; left:12px; right:12px;
    display:flex; gap:8px; pointer-events:auto; flex-wrap:wrap;
  }
  .btn {
    background:#011; color:#0ff; border:1px solid #055; border-radius:8px;
    padding:10px 14px; font-weight:700; cursor:pointer;
  }
  .mirror { transform:scaleX(-1); }
  .debug {
    position:absolute; top:120px; left:12px; right:12px;
    background:rgba(0,0,0,0.8); color:#0ff; padding:12px;
    font-family:monospace; font-size:12px; border:1px solid #055;
    max-height:200px; overflow-y:auto;
  }
  .status {
    position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
    background:rgba(0,0,0,0.9); color:#0ff; padding:20px;
    border:2px solid #055; border-radius:12px; text-align:center;
    font-family:monospace;
  }
</style>

<!-- ğŸ”¥ ì¤‘ìš”: Naver Maps APIë¥¼ ë¨¼ì € ë¡œë“œ -->
<script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=i6my73bw6a&submodules=geocoder"></script>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="status" class="status">
    <div style="font-size:24px; margin-bottom:12px;">ğŸ—ºï¸</div>
    <div>ì§€ë„ ë¡œë”© ì¤‘...</div>
  </div>
  <div id="hud" class="hud" style="display:none;">
    <div class="speed" id="speed">--</div>
    <div class="meta">
      <div>HDG <span id="heading">--</span>Â°</div>
      <div>LAT <span id="lat">--</span> Â· LNG <span id="lng">--</span></div>
      <div>ACC <span id="acc">--</span>m Â· SAT NA</div>
    </div>
  </div>
  <div class="debug" id="debug" style="display:none;">
    <div><strong>ë””ë²„ê·¸ ì •ë³´:</strong></div>
    <div id="debugInfo">ì´ˆê¸°í™” ì¤‘...</div>
  </div>
  <div class="panel">
    <button class="btn" id="mirrorBtn">ë¯¸ëŸ¬ ëª¨ë“œ</button>
    <button class="btn" id="themeBtn">ë‹¤í¬/ë¼ì´íŠ¸</button>
    <button class="btn" id="pauseBtn">ì¼ì‹œì •ì§€</button>
    <button class="btn" id="debugBtn">ë””ë²„ê·¸ í† ê¸€</button>
  </div>
</div>

<!-- ğŸ”¥ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” Naver Maps API ë¡œë“œ í›„ ì‹¤í–‰ -->
<script>
(function(){
  const debugLog = (msg) => {
    const debugDiv = document.getElementById('debugInfo');
    if (!debugDiv) return;
    const time = new Date().toLocaleTimeString();
    debugDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
    console.log('[DEBUG]', msg);
  };

  const statusDiv = document.getElementById('status');
  const hudDiv = document.getElementById('hud');
  const debugDiv = document.getElementById('debug');

  // ë””ë²„ê·¸ í† ê¸€
  document.getElementById('debugBtn').onclick = () => {
    debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
  };

  debugLog('=== ì´ˆê¸°í™” ì‹œì‘ ===');
  debugLog('í˜„ì¬ URL: ' + window.location.href);
  debugLog('í˜„ì¬ ë„ë©”ì¸: ' + window.location.hostname);
  debugLog('naver ê°ì²´ ì¡´ì¬: ' + (typeof naver !== 'undefined'));
  debugLog('naver.maps ì¡´ì¬: ' + (typeof naver !== 'undefined' && typeof naver.maps !== 'undefined'));

  // Naver Maps API í™•ì¸
  if (typeof naver === 'undefined' || typeof naver.maps === 'undefined') {
    statusDiv.innerHTML = `
      <div style="font-size:24px; margin-bottom:12px;">âŒ</div>
      <div style="color:#f00; margin-bottom:8px;">Naver Maps API ë¡œë“œ ì‹¤íŒ¨</div>
      <div style="font-size:12px; opacity:0.8;">
        í´ë¼ì´ì–¸íŠ¸ IDë¥¼ í™•ì¸í•˜ê±°ë‚˜<br>
        ë¡œì»¬ í…ŒìŠ¤íŠ¸ëŠ” http://localhost ë˜ëŠ” http://127.0.0.1ì„<br>
        Naver Cloud ì½˜ì†”ì— ë“±ë¡í•˜ì„¸ìš”
      </div>
    `;
    debugLog('âŒ FATAL: Naver Maps API ë¡œë“œ ì‹¤íŒ¨');
    return;
  }

  debugLog('âœ“ Naver Maps API ë¡œë“œ ì„±ê³µ');

  // --- helpers ---
  const toKmh = v => v == null ? null : Math.max(0, v * 3.6);
  const hav = (a)=>Math.sin(a/2)**2;
  const R = 6371000;
  const dist = (lat1,lon1,lat2,lon2)=>{
    const Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180, dÏ†=(lat2-lat1)*Math.PI/180, dÎ»=(lon2-lon1)*Math.PI/180;
    return 2*R*Math.asin(Math.sqrt(hav(dÏ†)+Math.cos(Ï†1)*Math.cos(Ï†2)*hav(dÎ»)));
  };
  const bearing = (lat1,lon1,lat2,lon2)=>{
    const Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180, Î»1=lon1*Math.PI/180, Î»2=lon2*Math.PI/180;
    const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
    const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
    let Î¸=Math.atan2(y,x)*180/Math.PI;
    return (Î¸+360)%360;
  };
  const ema = (alpha) => {
    let v=null; return x => { v = (v==null)? x : (alpha*x + (1-alpha)*v); return v; };
  };

  // --- map ì´ˆê¸°í™” ---
  let map, me;
  try {
    debugLog('ë§µ ê°ì²´ ìƒì„± ì‹œì‘...');
    map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.5665, 126.9780),
      zoom: 16,
      mapDataControl:false,
      logoControl:false,
      scaleControl:false,
      zoomControl:false,
      draggable:true,
      pinchZoom:true
    });
    debugLog('âœ“ ë§µ ê°ì²´ ìƒì„± ì„±ê³µ');

    me = new naver.maps.Marker({ 
      position: map.getCenter(), 
      map, 
      icon: { 
        content: '<div style="font-size:24px;">ğŸ”µ</div>', 
        anchor: new naver.maps.Point(12,12) 
      }
    });
    debugLog('âœ“ ë§ˆì»¤ ìƒì„± ì„±ê³µ');

    // ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê³  HUD í‘œì‹œ
    statusDiv.style.display = 'none';
    hudDiv.style.display = 'flex';
    
  } catch(e) {
    debugLog('âŒ ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
    statusDiv.innerHTML = `
      <div style="font-size:24px; margin-bottom:12px;">âŒ</div>
      <div style="color:#f00;">ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨</div>
      <div style="font-size:12px; margin-top:8px;">${e.message}</div>
    `;
    console.error(e);
    return;
  }

  // UI refs
  const $speed = document.getElementById('speed');
  const $heading = document.getElementById('heading');
  const $lat = document.getElementById('lat');
  const $lng = document.getElementById('lng');
  const $acc = document.getElementById('acc');
  const $app = document.getElementById('app');
  const hud = document.getElementById('hud');

  // controls
  document.getElementById('mirrorBtn').onclick = ()=> $app.classList.toggle('mirror');
  let dark=true;
  document.getElementById('themeBtn').onclick = ()=>{
    dark=!dark;
    document.body.style.background = dark ? '#000' : '#fff';
    hud.style.color = dark ? '#0ff' : '#005';
  };
  let paused=false;
  document.getElementById('pauseBtn').onclick = ()=>{
    paused = !paused;
    document.getElementById('pauseBtn').textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
    debugLog(paused ? 'ì¼ì‹œì •ì§€ë¨' : 'ì¬ê°œë¨');
  };

  // state
  let last = null;
  const smoothSpeed = ema(0.35);
  const smoothHeading = ema(0.25);
  let compass = null;

  // device orientation
  window.addEventListener('deviceorientation', (e)=>{
    const hdg = (e.webkitCompassHeading != null) ? e.webkitCompassHeading : (360 - (e.alpha||0));
    if (!isNaN(hdg)) compass = (hdg+360)%360;
  }, true);

  // geolocation stream
  if (!navigator.geolocation) {
    debugLog('âŒ Geolocation ë¯¸ì§€ì›');
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  
  debugLog('âœ“ Geolocation ì§€ì›ë¨ - ìœ„ì¹˜ ì¶”ì  ì‹œì‘');
  statusDiv.innerHTML = `
    <div style="font-size:24px; margin-bottom:12px;">ğŸ“</div>
    <div>GPS ì‹ í˜¸ ëŒ€ê¸° ì¤‘...</div>
    <div style="font-size:12px; margin-top:8px; opacity:0.8;">
      ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”
    </div>
  `;

  const watchId = navigator.geolocation.watchPosition(onPos, onErr, {
    enableHighAccuracy:true, 
    maximumAge:0, 
    timeout:10000
  });

  let firstFix = true;

  function onPos(p){
    if (firstFix) {
      statusDiv.style.display = 'none';
      hudDiv.style.display = 'flex';
      firstFix = false;
    }

    if (paused) return;
    
    const { latitude, longitude, accuracy, speed: vms } = p.coords;
    const now = { lat:latitude, lng:longitude, t:p.timestamp };
    let kmh = toKmh(vms);
    let hdg = compass;

    if (last){
      const d = dist(last.lat,last.lng, now.lat, now.lng);
      const dt = Math.max(0.5, (now.t - last.t)/1000);
      const v = d/dt;
      if (kmh==null || isNaN(kmh)) kmh = toKmh(v);
      if (hdg==null) hdg = bearing(last.lat,last.lng, now.lat, now.lng);
    }

    if (kmh!=null) kmh = smoothSpeed(kmh);
    if (hdg!=null) hdg = smoothHeading(hdg);

    // update map
    if (map && me) {
      const latlng = new naver.maps.LatLng(now.lat, now.lng);
      me.setPosition(latlng);
      map.setCenter(latlng);
      if (hdg!=null) map.setHeading(hdg);
    }

    // update HUD
    $speed.textContent = kmh!=null ? Math.round(kmh) : '--';
    $heading.textContent = hdg!=null ? Math.round(hdg) : '--';
    $lat.textContent = now.lat.toFixed(6);
    $lng.textContent = now.lng.toFixed(6);
    $acc.textContent = accuracy!=null ? Math.round(accuracy) : '--';

    if (!last) {
      debugLog('âœ“ ì²« GPS ìœ„ì¹˜ ìˆ˜ì‹ : ' + now.lat.toFixed(4) + ', ' + now.lng.toFixed(4));
      debugLog('âœ“ ì •í™•ë„: ' + Math.round(accuracy) + 'm');
    }
    last = now;
  }

  function onErr(err){
    debugLog('âŒ ìœ„ì¹˜ ì˜¤ë¥˜ [' + err.code + ']: ' + err.message);
    
    let errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    if (err.code === 1) {
      errorMsg = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
    } else if (err.code === 2) {
      errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>GPS ì‹ í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
    } else if (err.code === 3) {
      errorMsg = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
    
    statusDiv.innerHTML = `
      <div style="font-size:24px; margin-bottom:12px;">âš ï¸</div>
      <div style="color:#ff0;">${errorMsg}</div>
    `;
    statusDiv.style.display = 'block';
  }

  // iOS ê¶Œí•œ ìš”ì²­
  if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
    debugLog('iOS ë°©í–¥ ì„¼ì„œ ê¶Œí•œ í•„ìš” - í™”ë©´ í„°ì¹˜ ì‹œ ìš”ì²­');
    window.addEventListener('click', async function once(){
      window.removeEventListener('click', once);
      try { 
        const result = await DeviceOrientationEvent.requestPermission();
        debugLog('ë°©í–¥ ì„¼ì„œ ê¶Œí•œ: ' + result);
      } catch(e){
        debugLog('ë°©í–¥ ì„¼ì„œ ê¶Œí•œ ì˜¤ë¥˜: ' + e.message);
      }
    });
  }

  debugLog('=== ì´ˆê¸°í™” ì™„ë£Œ ===');
})();
</script>

</body>
</html>