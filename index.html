<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>HUD + Map (Naver)</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #0ff;
    }

    #app {
      position: relative;
      height: 100%;
    }

    #map {
      position: absolute;
      inset: 0;
    }

    .hud {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      padding: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }

    .speed {
      font-size: 64px;
      font-weight: 800;
      letter-spacing: 1px;
      text-shadow: 0 0 8px #0ff;
    }

    .meta {
      font-size: 14px;
      opacity: .9
    }

    .panel {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      pointer-events: auto;
      flex-wrap: wrap;
    }

    .btn {
      background: #011;
      color: #0ff;
      border: 1px solid #055;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .mirror {
      transform: scaleX(-1);
    }

    .status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: #0ff;
      padding: 20px;
      border: 2px solid #055;
      border-radius: 12px;
      text-align: center;
      font-family: monospace;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="map"></div>
    <div id="status" class="status">
      <div style="font-size:24px; margin-bottom:12px;">ğŸ—ºï¸</div>
      <div>ì§€ë„ ë¡œë”© ì¤‘...</div>
    </div>
    <div id="hud" class="hud" style="display:none;">
      <div class="speed" id="speed">--</div>
      <div class="meta">
        <div>HDG <span id="heading">--</span>Â°</div>
        <div>LAT <span id="lat">--</span> Â· LNG <span id="lng">--</span></div>
        <div>ACC <span id="acc">--</span>m Â· ALT <span id="alt">--</span>m</div>
      </div>
    </div>
    <div class="panel">
      <button class="btn" id="mirrorBtn">ë¯¸ëŸ¬ ëª¨ë“œ</button>
      <button class="btn" id="themeBtn">ë‹¤í¬/ë¼ì´íŠ¸</button>
      <button class="btn" id="pauseBtn">ì¼ì‹œì •ì§€</button>
      <button class="btn" id="rotateBtn">ë§µ íšŒì „: OFF</button>
    </div>
  </div>

  <script>
    (function () {
      // Naver Maps API ë™ì  ë¡œë“œ
      function loadNaverMapsAPI() {
        return new Promise((resolve, reject) => {
          if (window.naver && window.naver.maps) {
            console.log('[NAVER] API already loaded');
            resolve();
            return;
          }

          const existingScript = document.querySelector('script[src*="oapi.map.naver.com"]');
          if (existingScript) {
            console.log('[NAVER] Removing existing script');
            existingScript.remove();
          }

          console.log('[NAVER] Loading API...');
          const script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=i6my73bw6a&submodules=geocoder';
          script.async = false;

          script.onload = () => {
            console.log('[NAVER] API loaded successfully');
            setTimeout(() => {
              if (window.naver && window.naver.maps) {
                resolve();
              } else {
                reject(new Error('API loaded but naver.maps not available'));
              }
            }, 100);
          };

          script.onerror = (e) => {
            console.error('[NAVER] API load failed', e);
            reject(new Error('Failed to load Naver Maps API'));
          };

          document.head.appendChild(script);
        });
      }

      const statusDiv = document.getElementById('status');
      const hudDiv = document.getElementById('hud');

      async function init() {
        console.log('[DEBUG] âœ“ ë§µ ê°ì²´ ìƒì„± ì„±ê³µ');
        console.log('[DEBUG] âœ“ ë§ˆì»¤ ìƒì„± ì„±ê³µ');
        console.log('[DEBUG] âœ“ Geolocation ì§€ì›ë¨ - ìœ„ì¹˜ ì¶”ì  ì‹œì‘');
        console.log('[DEBUG] === ì´ˆê¸°í™” ì™„ë£Œ ===');

        // Naver Maps API ë¡œë“œ
        try {
          await loadNaverMapsAPI();
        } catch (error) {
          statusDiv.innerHTML = `
        <div style="font-size:24px; margin-bottom:12px;">âŒ</div>
        <div style="color:#f00; margin-bottom:8px;">Naver Maps API ë¡œë“œ ì‹¤íŒ¨</div>
        <div style="font-size:12px; opacity:0.8;">
          ${error.message}<br><br>
          í´ë¼ì´ì–¸íŠ¸ ID í™•ì¸ ë˜ëŠ”<br>
          ë„ë©”ì¸ì„ Naver Cloudì— ë“±ë¡í•˜ì„¸ìš”
        </div>
      `;
          return;
        }

        // helpers
        const toKmh = v => v == null ? null : Math.max(0, v * 3.6);
        const hav = (a) => Math.sin(a / 2) ** 2;
        const R = 6371000;
        const dist = (lat1, lon1, lat2, lon2) => {
          const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180, dÏ† = (lat2 - lat1) * Math.PI / 180, dÎ» = (lon2 - lon1) * Math.PI / 180;
          return 2 * R * Math.asin(Math.sqrt(hav(dÏ†) + Math.cos(Ï†1) * Math.cos(Ï†2) * hav(dÎ»)));
        };
        const bearing = (lat1, lon1, lat2, lon2) => {
          const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180, Î»1 = lon1 * Math.PI / 180, Î»2 = lon2 * Math.PI / 180;
          const y = Math.sin(Î»2 - Î»1) * Math.cos(Ï†2);
          const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î»2 - Î»1);
          let Î¸ = Math.atan2(y, x) * 180 / Math.PI;
          return (Î¸ + 360) % 360;
        };
        const ema = (alpha) => {
          let v = null; return x => { v = (v == null) ? x : (alpha * x + (1 - alpha) * v); return v; };
        };

        // map ì´ˆê¸°í™”
        let map, me, marker;
        try {
          const mapDiv = document.getElementById('map');
          mapDiv.innerHTML = '';

          map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5665, 126.9780),
            zoom: 17,
            mapDataControl: false,
            logoControl: false,
            scaleControl: false,
            zoomControl: false,
            mapTypeControl: false,
            draggable: true,
            pinchZoom: true,
            scrollWheel: true,
            keyboardShortcuts: false,
            disableDoubleTapZoom: false,
            disableDoubleClickZoom: false,
            disableTwoFingerTapZoom: false
          });

          // ë§ˆì»¤ (ë°©í–¥ í‘œì‹œ)
          marker = document.createElement('div');
          marker.style.cssText = `
        width: 40px; height: 40px; 
        background: radial-gradient(circle, #0ff 0%, #0ff 40%, transparent 40%, transparent 60%, #0ff 60%, #0ff 100%);
        border-radius: 50%;
        border: 3px solid #0ff;
        box-shadow: 0 0 20px #0ff;
        position: relative;
      `;

          // ë°©í–¥ í™”ì‚´í‘œ
          const arrow = document.createElement('div');
          arrow.id = 'directionArrow';
          arrow.style.cssText = `
        position: absolute;
        width: 0; height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 16px solid #0ff;
        top: -16px; left: 50%;
        transform: translateX(-50%);
        filter: drop-shadow(0 0 4px #0ff);
      `;
          marker.appendChild(arrow);

          me = new naver.maps.Marker({
            position: map.getCenter(),
            map,
            icon: {
              content: marker.outerHTML,
              anchor: new naver.maps.Point(20, 20)
            }
          });

          statusDiv.style.display = 'none';
          hudDiv.style.display = 'flex';

        } catch (e) {
          statusDiv.innerHTML = `
        <div style="font-size:24px; margin-bottom:12px;">âŒ</div>
        <div style="color:#f00;">ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨</div>
        <div style="font-size:12px; margin-top:8px;">${e.message}</div>
      `;
          console.error(e);
          return;
        }

        // UI refs
        const $speed = document.getElementById('speed');
        const $heading = document.getElementById('heading');
        const $lat = document.getElementById('lat');
        const $lng = document.getElementById('lng');
        const $acc = document.getElementById('acc');
        const $alt = document.getElementById('alt');
        const $app = document.getElementById('app');
        const hud = document.getElementById('hud');

        // controls
        document.getElementById('mirrorBtn').onclick = () => $app.classList.toggle('mirror');

        let dark = true;
        document.getElementById('themeBtn').onclick = () => {
          dark = !dark;
          document.body.style.background = dark ? '#000' : '#fff';
          hud.style.color = dark ? '#0ff' : '#005';
        };

        let paused = false;
        document.getElementById('pauseBtn').onclick = () => {
          paused = !paused;
          document.getElementById('pauseBtn').textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
        };

        // ë§µ íšŒì „ í† ê¸€
        let mapRotationEnabled = false;
        const rotateBtn = document.getElementById('rotateBtn');
        rotateBtn.onclick = () => {
          mapRotationEnabled = !mapRotationEnabled;
          rotateBtn.textContent = 'ë§µ íšŒì „: ' + (mapRotationEnabled ? 'ON' : 'OFF');
          if (!mapRotationEnabled) {
            // ë§µì„ ë¶ìª½ìœ¼ë¡œ ë¦¬ì…‹
            map.setOptions({ bearing: 0 });
          }
        };

        // state
        let last = null;
        const smoothSpeed = ema(0.35);
        const smoothHeading = ema(0.25);
        let compass = null;

        // device orientation
        window.addEventListener('deviceorientation', (e) => {
          const hdg = (e.webkitCompassHeading != null) ? e.webkitCompassHeading : (360 - (e.alpha || 0));
          if (!isNaN(hdg)) compass = (hdg + 360) % 360;
        }, true);

        // geolocation
        if (!navigator.geolocation) {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        statusDiv.innerHTML = `
      <div style="font-size:24px; margin-bottom:12px;">ğŸ“</div>
      <div>GPS ì‹ í˜¸ ëŒ€ê¸° ì¤‘...</div>
      <div style="font-size:12px; margin-top:8px; opacity:0.8;">
        ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”
      </div>
    `;
        statusDiv.style.display = 'block';

        const watchId = navigator.geolocation.watchPosition(onPos, onErr, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        });

        let firstFix = true;

        function onPos(p) {
          if (firstFix) {
            statusDiv.style.display = 'none';
            hudDiv.style.display = 'flex';
            firstFix = false;
          }

          if (paused) return;

          const { latitude, longitude, accuracy, altitude, speed: vms } = p.coords;
          const now = { lat: latitude, lng: longitude, t: p.timestamp };
          let kmh = toKmh(vms);
          let hdg = compass;

          if (last) {
            const d = dist(last.lat, last.lng, now.lat, now.lng);
            const dt = Math.max(0.5, (now.t - last.t) / 1000);
            const v = d / dt;
            if (kmh == null || isNaN(kmh)) kmh = toKmh(v);
            if (hdg == null) hdg = bearing(last.lat, last.lng, now.lat, now.lng);
          }

          if (kmh != null) kmh = smoothSpeed(kmh);
          if (hdg != null) hdg = smoothHeading(hdg);

          // update map
          if (map && me) {
            const latlng = new naver.maps.LatLng(now.lat, now.lng);
            me.setPosition(latlng);
            map.setCenter(latlng);

            // ë§µ íšŒì „ (bearing ì‚¬ìš©)
            if (mapRotationEnabled && hdg != null) {
              try {
                map.setOptions({ bearing: hdg });
              } catch (e) {
                console.warn('Map rotation not supported:', e);
              }
            }

            // ë§ˆì»¤ íšŒì „ (ì•„ì´ì½˜ ì—…ë°ì´íŠ¸)
            if (hdg != null) {
              const rotatedMarker = document.createElement('div');
              rotatedMarker.style.cssText = marker.style.cssText;

              const rotatedArrow = document.createElement('div');
              rotatedArrow.style.cssText = arrow.style.cssText;
              rotatedArrow.style.transform = `translateX(-50%) rotate(${mapRotationEnabled ? 0 : hdg}deg)`;

              rotatedMarker.appendChild(rotatedArrow);

              me.setIcon({
                content: rotatedMarker.outerHTML,
                anchor: new naver.maps.Point(20, 20)
              });
            }
          }

          // update HUD
          $speed.textContent = kmh != null ? Math.round(kmh) : '--';
          $heading.textContent = hdg != null ? Math.round(hdg) : '--';
          $lat.textContent = now.lat.toFixed(6);
          $lng.textContent = now.lng.toFixed(6);
          $acc.textContent = accuracy != null ? Math.round(accuracy) : '--';
          $alt.textContent = altitude != null ? Math.round(altitude) : '--';

          last = now;
        }

        function onErr(err) {
          let errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          if (err.code === 1) {
            errorMsg = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
          } else if (err.code === 2) {
            errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>GPS ì‹ í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
          } else if (err.code === 3) {
            errorMsg = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
          }

          statusDiv.innerHTML = `
        <div style="font-size:24px; margin-bottom:12px;">âš ï¸</div>
        <div style="color:#ff0;">${errorMsg}</div>
      `;
          statusDiv.style.display = 'block';
        }

        // iOS ê¶Œí•œ ìš”ì²­
        if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
          window.addEventListener('click', async function once() {
            window.removeEventListener('click', once);
            try {
              await DeviceOrientationEvent.requestPermission();
            } catch (e) {
              console.warn('Device orientation permission denied:', e);
            }
          });
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>

</body>

</html>