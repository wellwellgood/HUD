<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HUD + Map (Naver)</title>
<style>
  html, body { height: 100%; margin: 0; background:#000; color:#0ff; }
  #app { position:relative; height:100%; }
  #map { position:absolute; inset:0; }
  .hud {
    position:absolute; left:0; right:0; top:0; padding:16px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    pointer-events:none; font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
  }
  .speed { font-size:64px; font-weight:800; letter-spacing:1px; text-shadow:0 0 8px #0ff; }
  .meta  { font-size:14px; opacity:.9 }
  .panel {
    position:absolute; bottom:12px; left:12px; right:12px;
    display:flex; gap:8px; pointer-events:auto;
  }
  .btn {
    background:#011; color:#0ff; border:1px solid #055; border-radius:8px;
    padding:10px 14px; font-weight:700; cursor:pointer;
  }
  .mirror { transform:scaleX(-1); }
</style>
<script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=k088fbm2t0&submodules=geocoder"></script>
</head>
<body>
<div id="app">
  <div id="map"></div>
  <div id="hud" class="hud">
    <div class="speed" id="speed">--</div>
    <div class="meta">
      <div>HDG <span id="heading">--</span>Â°</div>
      <div>LAT <span id="lat">--</span> Â· LNG <span id="lng">--</span></div>
      <div>ACC <span id="acc">--</span>m Â· SAT NA</div>
    </div>
  </div>
  <div class="panel">
    <button class="btn" id="mirrorBtn">ë¯¸ëŸ¬ ëª¨ë“œ</button>
    <button class="btn" id="themeBtn">ë‹¤í¬/ë¼ì´íŠ¸</button>
    <button class="btn" id="pauseBtn">ì¼ì‹œì •ì§€</button>
  </div>
</div>

<script>
(function(){
  // --- helpers ---
  const toKmh = v => v == null ? null : Math.max(0, v * 3.6);
  const hav = (a)=>Math.sin(a/2)**2;
  const R = 6371000;
  const dist = (lat1,lon1,lat2,lon2)=>{
    const Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180, dÏ†=(lat2-lat1)*Math.PI/180, dÎ»=(lon2-lon1)*Math.PI/180;
    return 2*R*Math.asin(Math.sqrt(hav(dÏ†)+Math.cos(Ï†1)*Math.cos(Ï†2)*hav(dÎ»)));
  };
  const bearing = (lat1,lon1,lat2,lon2)=>{
    const Ï†1=lat1*Math.PI/180, Ï†2=lat2*Math.PI/180, Î»1=lon1*Math.PI/180, Î»2=lon2*Math.PI/180;
    const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
    const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
    let Î¸=Math.atan2(y,x)*180/Math.PI;
    return (Î¸+360)%360;
  };
  const ema = (alpha) => {
    let v=null; return x => { v = (v==null)? x : (alpha*x + (1-alpha)*v); return v; };
  };

  // --- map ---
  const map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.5665, 126.9780),
    zoom: 16,
    mapDataControl:false,
    logoControl:false,
    scaleControl:false,
    zoomControl:false,
    draggable:true, // í•„ìš” ì‹œ false
    pinchZoom:true
  });
  const me = new naver.maps.Marker({ position: map.getCenter(), map, icon: { content: 'ğŸ”µ', anchor: new naver.maps.Point(10,10) }});

  // UI refs
  const $speed = document.getElementById('speed');
  const $heading = document.getElementById('heading');
  const $lat = document.getElementById('lat');
  const $lng = document.getElementById('lng');
  const $acc = document.getElementById('acc');
  const $app = document.getElementById('app');
  const hud = document.getElementById('hud');

  // controls
  document.getElementById('mirrorBtn').onclick = ()=> $app.classList.toggle('mirror');
  let dark=true;
  document.getElementById('themeBtn').onclick = ()=>{
    dark=!dark;
    document.body.style.background = dark ? '#000' : '#fff';
    hud.style.color = dark ? '#0ff' : '#005';
  };
  let paused=false;
  document.getElementById('pauseBtn').onclick = ()=>{
    paused = !paused;
    document.getElementById('pauseBtn').textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
  };

  // state
  let last = null;
  const smoothSpeed = ema(0.35);
  const smoothHeading = ema(0.25);
  let compass = null;

  // device orientation (iOS: absolute heading)
  window.addEventListener('deviceorientation', (e)=>{
    // iOS webkitCompassHeading, ì•ˆ ë˜ë©´ e.alpha ì‚¬ìš©
    const hdg = (e.webkitCompassHeading != null) ? e.webkitCompassHeading : (360 - (e.alpha||0));
    if (!isNaN(hdg)) compass = (hdg+360)%360;
  }, true);

  // geolocation stream
  if (!navigator.geolocation) {
    alert('Geolocation ë¯¸ì§€ì›');
    return;
  }
  const watchId = navigator.geolocation.watchPosition(onPos, onErr, {
    enableHighAccuracy:true, maximumAge:0, timeout:10000
  });

  function onPos(p){
    if (paused) return;
    const { latitude, longitude, accuracy, speed: vms } = p.coords;
    const now = { lat:latitude, lng:longitude, t:p.timestamp };
    let kmh = toKmh(vms);
    let hdg = compass;

    if (last){
      const d = dist(last.lat,last.lng, now.lat, now.lng);
      const dt = Math.max(0.5, (now.t - last.t)/1000);
      const v = d/dt; // m/s
      if (kmh==null || isNaN(kmh)) kmh = toKmh(v);
      if (hdg==null) hdg = bearing(last.lat,last.lng, now.lat, now.lng);
    }

    if (kmh!=null) kmh = smoothSpeed(kmh);
    if (hdg!=null) hdg = smoothHeading(hdg);

    // update map
    const latlng = new naver.maps.LatLng(now.lat, now.lng);
    me.setPosition(latlng);
    map.setCenter(latlng);
    if (hdg!=null) map.setHeading(hdg); // íšŒì „ HUD íš¨ê³¼

    // update HUD
    $speed.textContent = kmh!=null ? Math.round(kmh) : '--';
    $heading.textContent = hdg!=null ? Math.round(hdg) : '--';
    $lat.textContent = now.lat.toFixed(6);
    $lng.textContent = now.lng.toFixed(6);
    $acc.textContent = accuracy!=null ? Math.round(accuracy) : '--';

    last = now;
  }

  function onErr(err){
    alert('ìœ„ì¹˜ ì˜¤ë¥˜: ' + err.message);
  }

  // ê¶Œí•œ ìš”ì²­(iOS 13+ ë°©í–¥ ì„¼ì„œ)
  if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
    // ì‚¬ìš©ìê°€ ë²„íŠ¼ ëˆŒëŸ¬ì•¼ í—ˆìš© ê°€ëŠ¥. ì²« í„°ì¹˜ ì´ë²¤íŠ¸ì— ë¬¶ì–´ ìš”ì²­í•˜ëŠ” ê²ƒì´ ì•ˆì „.
    window.addEventListener('click', async function once(){
      window.removeEventListener('click', once);
      try { await DeviceOrientationEvent.requestPermission(); } catch(e){}
    });
  }
})();
</script>
</body>
</html>
